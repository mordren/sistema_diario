{% extends "base.html" %}
{% block title %}AnÃ¡lise de {{ analise.nome if analise else 'NÃ£o encontrada' }}{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if analise %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ” AnÃ¡lise de ReputaÃ§Ã£o â€” {{ analise.nome }}</h2>
        <span class="badge bg-secondary">ID #{{ analise.id }}</span>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center mb-3 
                {% if analise.risco_reputacao|lower in ['critica', 'alta', 'alto'] %}border-danger
                {% elif analise.risco_reputacao|lower in ['media', 'mÃ©dia', 'medio'] %}border-warning
                {% else %}border-success{% endif %}">
                <div class="card-body">
                    <h5 class="card-title">ğŸš¨ NÃ­vel de Risco</h5>
                    <h3 class="
                        {% if analise.risco_reputacao|lower in ['critica', 'alta', 'alto'] %}text-danger
                        {% elif analise.risco_reputacao|lower in ['media', 'mÃ©dia', 'medio'] %}text-warning
                        {% else %}text-success{% endif %} fw-bold">
                        {% if analise.risco_reputacao|lower in ['baixa', 'baixo'] %}
                            BAIXO âœ…
                        {% elif analise.risco_reputacao|lower in ['media', 'mÃ©dia', 'medio'] %}
                            MÃ‰DIO âš ï¸
                        {% elif analise.risco_reputacao|lower in ['alta', 'alto'] %}
                            ALTO ğŸš¨
                        {% elif analise.risco_reputacao|lower in ['critica', 'crÃ­tica'] %}
                            CRÃTICO ğŸ’€
                        {% else %}
                            {{ analise.risco_reputacao|upper if analise.risco_reputacao else "N/A" }}
                        {% endif %}
                    </h3>
                    <small class="text-muted">
                        {% if analise.risco_reputacao|lower in ['baixa', 'baixo'] %}
                            ReputaÃ§Ã£o predominantemente positiva
                        {% elif analise.risco_reputacao|lower in ['media', 'mÃ©dia', 'medio'] %}
                            Algumas questÃµes a observar
                        {% elif analise.risco_reputacao|lower in ['alta', 'alto'] %}
                            AtenÃ§Ã£o necessÃ¡ria
                        {% else %}
                            AvaliaÃ§Ã£o de risco reputacional
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center border-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">ğŸ“… Data da AnÃ¡lise</h5>
                    <h3>
                        {% if analise.data_analise %}
                            {% if analise.data_analise is string %}
                                {{ analise.data_analise[:10] }}
                            {% else %}
                                {{ analise.data_analise.strftime('%Y-%m-%d') }}
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center border-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">ğŸ¯ PolÃªmicas Encontradas</h5>
                    <h3 class="text-warning">
                        {{ analise.total_polemicas if analise.total_polemicas is defined else (analise.polemicas|length if analise.polemicas else 0) }}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    {% if analise.cargo %}
    <div class="card mb-4">
        <div class="card-header bg-light"><strong>ğŸ’¼ Cargo/FunÃ§Ã£o</strong></div>
        <div class="card-body">
            <p>{{ analise.cargo }}</p>
        </div>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header bg-light"><strong>ğŸ“‹ Resumo da AnÃ¡lise</strong></div>
        <div class="card-body">
            <p>{{ analise.resumo_analise if analise.resumo_analise else "Nenhum resumo disponÃ­vel." }}</p>
        </div>
    </div>

    {% if analise.recomendacoes %}
    <div class="card mb-4">
        <div class="card-header bg-light"><strong>ğŸ’¡ RecomendaÃ§Ãµes</strong></div>
        <div class="card-body">
            <p>{{ analise.recomendacoes }}</p>
        </div>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header bg-light"><strong>ğŸ”— Fontes Consultadas</strong></div>
        <div class="card-body">
            {% if analise.fontes_consultadas and analise.fontes_consultadas|length > 0 %}
                <ul class="mb-0">
                    {% for f in analise.fontes_consultadas %}
                        <li>{{ f }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="mb-0 text-muted">Nenhuma fonte registrada.</p>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light"><strong>ğŸ¯ PolÃªmicas Identificadas</strong></div>
        <div class="card-body">
            {% if analise.polemicas and analise.polemicas|length > 0 %}
                {% for p in analise.polemicas %}
                    <div class="mb-4 p-3 border rounded 
                        {% if p.gravidade|lower in ['critica', 'alta'] %}border-danger bg-danger bg-opacity-10
                        {% elif p.gravidade|lower == 'media' %}border-warning bg-warning bg-opacity-10
                        {% else %}border-info bg-info bg-opacity-10{% endif %}">
                        
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="
                                {% if p.gravidade|lower in ['critica', 'alta'] %}text-danger
                                {% elif p.gravidade|lower == 'media' %}text-warning
                                {% else %}text-info{% endif %}">
                                {{ p.titulo if p.titulo else "Sem tÃ­tulo" }}
                            </h5>
                            <span class="badge 
                                {% if p.gravidade|lower in ['critica', 'alta'] %}bg-danger
                                {% elif p.gravidade|lower == 'media' %}bg-warning
                                {% else %}bg-info{% endif %}">
                                {{ p.gravidade|upper if p.gravidade else "N/A" }}
                            </span>
                        </div>
                        
                        <p><strong>ğŸ“ DescriÃ§Ã£o:</strong> {{ p.descricao if p.descricao else "Sem descriÃ§Ã£o disponÃ­vel" }}</p>
                        
                        {% if p.categoria %}
                        <p><strong>ğŸ“‚ Categoria:</strong> 
                            <span class="badge bg-secondary">{{ p.categoria }}</span>
                        </p>
                        {% endif %}
                        
                        {% if p.fonte_url or p.fonte %}
                        <p><strong>ğŸ”— Fonte:</strong> 
                            {% if p.fonte_url %}
                                <a href="{{ p.fonte_url }}" target="_blank" rel="noopener noreferrer">
                                    {{ p.fonte_url[:80] }}{% if p.fonte_url|length > 80 %}...{% endif %}
                                </a>
                            {% elif p.fonte %}
                                {{ p.fonte }}
                            {% endif %}
                        </p>
                        {% endif %}
                        
                        {% if p.impacto_publico or p.impacto %}
                        <p><strong>ğŸ“Š Impacto:</strong> {{ p.impacto_publico if p.impacto_publico else p.impacto }}</p>
                        {% endif %}
                        
                        {% if p.data_publicacao %}
                        <p><strong>ğŸ“… Data:</strong> {{ p.data_publicacao }}</p>
                        {% endif %}
                        
                        {% if p.evidencias %}
                        <details class="mt-2">
                            <summary class="text-muted" style="cursor: pointer;">ğŸ” Ver evidÃªncias</summary>
                            <div class="mt-2 p-2 bg-light rounded">
                                {% for evidencia in p.evidencias %}
                                    <p class="small mb-1">â€¢ {{ evidencia }}</p>
                                {% endfor %}
                            </div>
                        </details>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-success mb-0">
                    âœ… Nenhuma polÃªmica significativa encontrada.
                </div>
            {% endif %}
        </div>
    </div>

    {% if analise.empresas_associadas and analise.empresas_associadas|length > 0 %}
    <div class="card mb-4">
        <div class="card-header bg-light"><strong>ğŸ¢ Empresas Associadas</strong></div>
        <div class="card-body">
            {% for e in analise.empresas_associadas %}
                <div class="border rounded p-3 mb-3">
                    <h6 class="fw-bold">{{ e.nome_empresa }}</h6>
                    {% if e.cnpj %}<p><strong>CNPJ:</strong> {{ e.cnpj }}</p>{% endif %}
                    {% if e.relacao %}<p><strong>RelaÃ§Ã£o:</strong> {{ e.relacao }}</p>{% endif %}
                    {% if e.fonte_url %}
                    <p><strong>Fonte:</strong> 
                        <a href="{{ e.fonte_url }}" target="_blank" rel="noopener noreferrer">
                            {{ e.fonte_url[:60] }}{% if e.fonte_url|length > 60 %}...{% endif %}
                        </a>
                    </p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if analise.tweets_relevantes and analise.tweets_relevantes|length > 0 %}
    <div class="card mb-4">
        <div class="card-header bg-light"><strong>ğŸ¦ Tweets Relevantes</strong></div>
        <div class="card-body">
            {% for t in analise.tweets_relevantes %}
                <div class="border rounded p-3 mb-3 bg-light">
                    {% if t is string %}
                        {% set tweet_data = t|safe %}
                        <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;">{{ tweet_data }}</pre>
                    {% else %}
                        <p class="mb-1"><strong>{{ t.texto if t.texto else 'Tweet' }}</strong></p>
                        {% if t.descricao %}<p class="small text-muted mb-1">{{ t.descricao }}</p>{% endif %}
                        {% if t.url %}
                        <a href="{{ t.url }}" target="_blank" rel="noopener noreferrer" class="small">
                            Ver tweet original â†’
                        </a>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="text-end mt-4">
        <a href="{{ url_for('listar_analises') }}" class="btn btn-secondary">â¬…ï¸ Voltar para Lista</a>
        <button onclick="window.print()" class="btn btn-primary">ğŸ–¨ï¸ Imprimir</button>
    </div>

    {% else %}
    <div class="alert alert-danger">
        <h4>âŒ AnÃ¡lise nÃ£o encontrada</h4>
        <p>A anÃ¡lise solicitada nÃ£o existe ou foi removida.</p>
        <a href="{{ url_for('listar_analises') }}" class="btn btn-secondary">â¬…ï¸ Voltar para Lista</a>
    </div>
    {% endif %}
</div>

<style>
@media print {
    .btn, nav, .card-header { display: none; }
}
</style>
{% endblock %}